
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <!-- Para m√≥viles: evita zoom accidental y habilita PWA -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>El Trapial ‚Äî Evaluaci√≥n de Riesgo para Trabajo El√©ctrico</title>

  <!-- PWA manifest (correcto y NO visible) -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#005daa">

  <style>
    :root {
      --brand-prim: #005daa;
      --brand-sec:  #ed1c24;
      --bg: #eef2f3;
      --fg: #333;
      --card: #fff;
      --muted: #6c757d;
      --ok: #2e7d32;
      --warn: #c62828;
    }
    [data-theme="dark"] {
      --bg: #0f1419; --fg: #e6e6e6; --card: #151a21; --muted: #8a94a6;
    }
    html, body { background: var(--bg); color: var(--fg); }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; padding: 10px; margin:0; }
    .card { background: var(--card); max-width: 900px; margin: auto; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); overflow: hidden; }
    .header-logo { background: var(--card); padding: 18px 20px; display: flex; align-items: center; gap: 12px; border-bottom: 4px solid var(--brand-prim); }
    .brand-name { color: var(--brand-prim); font-weight: 800; font-size: 1.2em; letter-spacing: 0.3px; }
    .content { padding: 20px; }
    h2 { color: var(--brand-prim); text-align: center; font-size: 1.25em; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    h3 { color: var(--brand-prim); font-size: 1.05em; margin-top: 18px; }
    label { font-weight: 600; display: block; margin-top: 12px; font-size: 0.92em; }
    input, select { width: 100%; padding: 11px; margin-top: 6px; border: 1.4px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1em; background: var(--card); color: var(--fg); }
    small { color:#555; display:block; }
    .calc-box { background: #f8f9fa; padding: 15px; border: 1px solid var(--brand-prim); border-radius: 8px; margin-top: 16px; }
    .calc-box h3 { color: var(--brand-prim); margin-top: 0; font-size: 1em; }
    .alerta-loto { background: var(--brand-sec); color: white; padding: 10px; border-radius: 6px; margin-top: 10px; font-weight: bold; display: none; text-align: center; }

    .btn-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .btn { flex: 1; padding: 12px; background: var(--brand-prim); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1em; }
    .btn-secondary { background: var(--muted); color: #fff; }
    .btn-danger { background: var(--brand-sec); }
    .btn-ghost { background: transparent; color: var(--brand-prim); border: 1px solid var(--brand-prim); }
    .btn-ok { background: var(--ok); color:#fff; }

    #res-display { margin-top: 16px; padding: 16px; border-radius: 8px; display: none; border: 2px solid; text-align: left; }
    .disclaimer { font-size: 0.78em; color: #222; background: #fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 6px; margin-top: 12px; }
    .help { font-size:0.82em; color:#444; }

    .vit-grid { margin-top:14px; }
    .vit-header { display:flex; justify-content:space-between; align-items:center; }
    .vit-cards { display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; margin-top:12px; }
    @media (min-width: 860px) { .vit-cards { grid-template-columns: repeat(4, 1fr); } }
    .vit-card { background:#fff; border:1px solid #ddd; border-radius:10px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
    .vit-img { width:100%; height:120px; background:#f0f3f8; display:flex; align-items:center; justify-content:center; }
    .vit-img img { width:100%; height:100%; object-fit:cover; display:block; }
    .vit-icon { font-size:40px; color:#0d47a1; }
    .vit-body { padding:10px; }
    .vit-title { font-weight:700; color:#0d47a1; margin-bottom:6px; }
    .vit-check { display:flex; align-items:center; gap:8px; margin-top:6px; }
    .vit-check input { transform:scale(1.2); }
    .vit-note { font-size:0.84em; color:#555; margin-top:4px; }

    .chip { display:inline-block; background:#e3f2fd; border:1px solid #90caf9; color:#0d47a1; padding:4px 8px; border-radius:999px; font-size:0.85em; margin-top:6px; }

    /* ===== MODAL de ayuda ===== */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 9999; }
    .modal { background: #fff; color:#111; max-width: 820px; width: 96%; border-radius: 12px; box-shadow: 0 12px 32px rgba(0,0,0,0.35); padding: 18px; position: relative; }
    .modal h4 { margin: 0 0 8px 0; color: var(--brand-prim); }
    .modal .close-btn { position:absolute; right: 12px; top: 12px; border:none; background:transparent; font-size: 1.2em; cursor:pointer; color:#444; }
    .modal-grid { display:grid; grid-template-columns: 200px 1fr; gap:12px; align-items:start; margin-top:10px; }
    .modal-grid img { width:100%; height:140px; object-fit:cover; border-radius:8px; background:#f5f7fb; }
    .modal-grid .m-title { font-weight:700; color:#0d47a1; margin-bottom:4px; }
    .info-btn { display:inline-block; margin-left:8px; padding:4px 8px; font-size:0.9em; border:1px solid var(--brand-prim); color: var(--brand-prim); border-radius:8px; background: #fff; cursor:pointer; }

    /* ===== OVERLAY PROHIBICI√ìN CAT 3/4 ===== */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.75);
      display: none; align-items: center; justify-content: center; z-index: 9999;
    }
    .overlay .panel {
      background: #fff; color:#111; width: min(800px, 90vw); border-radius: 16px; padding: 24px;
      box-shadow: 0 12px 48px rgba(0,0,0,.5); border: 6px solid #d0021b; /* rojo */
    }
    .panel h3 { margin-top:0; font-size: 28px; }
    .callout { background: #ffe9ec; border-left: 6px solid #d0021b; padding: 12px 16px; margin: 12px 0; }
    .panel .actions { display:flex; gap: 12px; margin-top: 16px; flex-wrap: wrap; }
    .btn.primary   { background: #d0021b; color:#fff; }
    .btn.secondary { background: #eee; color:#111; }
  </style>
</head>
<body>

<div class="card" id="appCard" data-theme="light">
  <div class="header-logo" aria-label="Encabezado El Trapial">
    <span class="brand-name">EL TRAPIAL ‚Äî Evaluaci√≥n de Riesgo para Trabajo El√©ctrico</span>
    <button class="btn btn-ghost mode-toggle" id="btnMode">üåô Modo oscuro</button>
  </div>

  <div class="content">
    <h2>Evaluaci√≥n preliminar de arco el√©ctrico, choque, VIT y generaci√≥n de etiqueta</h2>

    <!-- Identificaci√≥n -->
    <label for="nombre">Nombre del Operador:</label>
    <input type="text" id="nombre" autocomplete="name" placeholder="Ej: J. Perusini"/>
    <label for="equipo">Equipo / Tag / Activo:</label>
    <input type="text" id="equipo" placeholder="Ej: MCC-03 / Tablero 480V"/>

    <!-- Tipo de tarea y LOTO -->
    <label for="tipo">Tipo de Tarea:</label>
    <select id="tipo" onchange="verificarTarea()" aria-label="Tipo de tarea">
      <option value="Inspeccion">Inspecci√≥n Visual</option>
      <option value="Medicion">Medici√≥n / Pruebas de Voltaje</option>
      <option value="Contacto">Trabajo a Contacto (Mantenimiento)</option>
    </select>
    <div id="alertaPeligro" class="alerta-loto">‚ö†Ô∏è REGLA QUE SALVA VIDAS: REQUIERE AISLAMIENTO Y BLOQUEO (LOTO)</div>

    <!-- Par√°metros el√©ctricos -->
    <div class="calc-box">
      <h3>üìà Par√°metros para c√°lculo</h3>
      <div class="row">
        <div>
          <label for="volt">Tensi√≥n del sistema (V L-L):</label>
          <input type="number" id="volt" placeholder="Ej: 400 / 440 / 480" step="1" min="100"/>
          <small class="help">Usamos este valor como tensi√≥n secundaria (VLL) para calcular el corto.</small>
        </div>
        <div>
          <label for="dist">Distancia de trabajo (cm):</label>
          <input type="number" id="dist" placeholder="Ej: 61" step="1" min="1"/>
        </div>
      </div>

      <h3>‚öôÔ∏è Transformador (solo potencia) <button class="info-btn" id="btnInfoZ">‚ÑπÔ∏è Z% t√≠pica</button></h3>
      <div class="row">
        <div>
          <label for="kva">Potencia del transformador (kVA):</label>
          <input type="number" id="kva" placeholder="10‚Äì1000" step="1" min="10" max="1000"/>
          <small class="help">La impedancia (Z%) se asigna autom√°ticamente seg√∫n el rango t√≠pico.</small>
        </div>
        <div>
          <label>Impedancia utilizada (Z%):</label>
          <input type="text" id="zpct_view" readonly value="‚Äî"/>
          <small class="help">Valor t√≠pico seg√∫n el rango de kVA. Puede diferir del valor de placa (estimaci√≥n preliminar).</small>
        </div>
      </div>

      <h3>üõ°Ô∏è Dispositivo de protecci√≥n (gen√©rico) <button class="info-btn" id="btnInfoDP">‚ÑπÔ∏è Info DP</button></h3>
      <div class="row">
        <div>
          <label for="dp_tipo_gen">Tipo de protecci√≥n:</label>
          <select id="dp_tipo_gen">
            <option value="MCCB_CHICO">MCCB peque√±o (‚â§250 A)</option>
            <option value="MCCB_MEDIO">MCCB mediano (250‚Äì630 A)</option>
            <option value="FUSIBLE_J">Fusible Clase J</option>
            <option value="FUSIBLE_RK5">Fusible Clase RK5</option>
            <option value="DISY_GRANDE">Disyuntor industrial (>630 A)</option>
            <option value="OTRO">Otro (editar manual)</option>
          </select>
          <span id="dp_chip" class="chip">t=‚Äî s ‚Ä¢ kA=‚Äî</span>
        </div>
        <div>
          <label><input type="checkbox" id="dp_avanzado"/> Editar valores avanzados (t/kA)</label>
          <div class="row" id="dp_avanzado_box" style="display:none; margin-top:8px;">
            <div>
              <label for="tiempo">Tiempo de despeje (s):</label>
              <input type="number" id="tiempo" placeholder="Ej: 0.015" step="0.001" min="0.005"/>
            </div>
            <div>
              <label for="dp_kA">Capacidad interruptiva (kA):</label>
              <input type="number" id="dp_kA" placeholder="Ej: 36" step="1" min="1"/>
            </div>
          </div>
        </div>
      </div>

      <div class="disclaimer">
        ‚ö†Ô∏è C√°lculo <strong>estimativo</strong> (no IEEE 1584). La selecci√≥n de EPP por <strong>categor√≠as NFPA 70E</strong> se muestra como <em>orientativa</em> cuando el m√©todo principal es por energ√≠a incidente. Use siempre un m√©todo <strong>√∫nico</strong> por equipo (tablas <strong>o</strong> EI) y siga permisos/LOTO.
      </div>
    </div>

    <!-- VIT (Verificaci√≥n para Inicio de Trabajo) el√©ctrica con im√°genes -->
    <div class="vit-grid">
      <div class="vit-header">
        <h3>‚úÖ VIT ‚Äî Verificaciones para el inicio del trabajo (El√©ctrico)</h3>
        <button class="info-btn" id="btnVITGuia">üì∑ Ver gu√≠a visual VIT</button>
      </div>

      <div class="vit-cards">
        <!-- 1 Alcance -->
        <div class="vit-card">
          <div class="vit-img" id="img_alcance"><span class="vit-icon">üìù</span></div>
          <div class="vit-body">
            <div class="vit-title">1) Alcance autorizado</div>
            <div class="vit-check"><input type="checkbox" id="vit1"/><label for="vit1">Revisado y aceptado (permiso/plan).</label></div>
            <div class="vit-note">Incluye analizar detener el trabajo si cambian condiciones.</div>
          </div>
        </div>
        <!-- 2 Identificaci√≥n -->
        <div class="vit-card">
          <div class="vit-img" id="img_identificacion"><span class="vit-icon">üè∑Ô∏è</span></div>
          <div class="vit-body">
            <div class="vit-title">2) Identificaci√≥n del equipo</div>
            <div class="vit-check"><input type="checkbox" id="vit2"/><label for="vit2">Circuito/equipo correcto y etiquetado en el plan.</label></div>
            <div class="vit-note">Verificar n√∫meros de etiqueta o marcas de cables.</div>
          </div>
        </div>
        <!-- 3 EPP calificado -->
        <div class="vit-card">
          <div class="vit-img" id="img_epp"><span class="vit-icon">üß§</span></div>
          <div class="vit-body">
            <div class="vit-title">3) EPP calificado</div>
            <div class="vit-check"><input type="checkbox" id="vit3"/><label for="vit3">EPP para peligros el√©ctricos y arco, inspeccionado y sin da√±os.</label></div>
            <div class="vit-note">Usar ATPV acorde a EI y/o tablas NFPA 70E.</div>
          </div>
        </div>
        <!-- 4 Barreras/acceso -->
        <div class="vit-card">
          <div class="vit-img" id="img_barreras"><span class="vit-icon">üöß</span></div>
          <div class="vit-body">
            <div class="vit-title">4) Barreras/√°rea restringida</div>
            <div class="vit-check"><input type="checkbox" id="vit4"/><label for="vit4">Barreras colocadas y control de acceso.</label></div>
            <div class="vit-note">Cumplir pol√≠tica interna / NFPA 70E (l√≠mites). </div>
          </div>
        </div>
        <!-- 5 Guardia el√©ctrica -->
        <div class="vit-card">
          <div class="vit-img" id="img_guardia"><span class="vit-icon">üëÆ</span></div>
          <div class="vit-body">
            <div class="vit-title">5) Guardia el√©ctrica</div>
            <div class="vit-check"><input type="checkbox" id="vit5"/><label for="vit5">Presente (si aplica) y con responsabilidades acordadas.</label></div>
            <div class="vit-note">Control de ingreso, monitoreo de condiciones, inicio de rescate.</div>
          </div>
        </div>
        <!-- 6 Comunicaci√≥n -->
        <div class="vit-card">
          <div class="vit-img" id="img_comunicacion"><span class="vit-icon">üì£</span></div>
          <div class="vit-body">
            <div class="vit-title">6) Plan de comunicaci√≥n</div>
            <div class="vit-check"><input type="checkbox" id="vit6"/><label for="vit6">Acordado y probado con el equipo.</label></div>
            <div class="vit-note">Se√±ales para detener el trabajo y activar emergencias.</div>
          </div>
        </div>
        <!-- 7 Herramientas/Ensayos -->
        <div class="vit-card">
          <div class="vit-img" id="img_herramientas"><span class="vit-icon">üîß</span></div>
          <div class="vit-body">
            <div class="vit-title">7) Herramientas y equipos de prueba</div>
            <div class="vit-check"><input type="checkbox" id="vit7"/><label for="vit7">Certificados, inspeccionados, calificados. Prueba de voltaje antes de usar.</label></div>
            <div class="vit-note">Aislamientos (esteras/pantallas), equipos ensayados.</div>
          </div>
        </div>
        <!-- 8 Emergencias -->
        <div class="vit-card">
          <div class="vit-img" id="img_emergencias"><span class="vit-icon">üÜò</span></div>
          <div class="vit-body">
            <div class="vit-title">8) Plan de emergencias</div>
            <div class="vit-check"><input type="checkbox" id="vit8"/><label for="vit8">Listo en sitio (ganchos, guantes, extintor). Equipo de rescate disponible.</label></div>
            <div class="vit-note">Definir m√©todo de comunicaci√≥n con guardia y equipo de rescate.</div>
          </div>
        </div>
      </div>

      <small class="help">La etiqueta y el c√°lculo s√≥lo se habilitan si todas las verificaciones est√°n OK.</small>
    </div>

    <!-- Acciones -->
    <div class="btn-row">
      <button class="btn" id="btnCalcular">VALIDAR TRABAJO Y CALCULAR</button>
      <button class="btn btn-danger" id="btnDescargar">Descargar Reporte</button>
      <button class="btn btn-secondary" id="btnGuardarRegistro">Guardar Registro</button>
      <button class="btn btn-secondary" id="btnCargarRegistro">Cargar √öltimo</button>
      <button class="btn" id="btnCrearEtiqueta">CREAR ETIQUETA</button>
    </div>

    <!-- Resultados -->
    <div id="res-display" role="status" aria-live="polite"></div>

    <!-- Contenedor etiqueta generada -->
    <div id="etiqueta-container" class="etiqueta-box" style="display:none;">
      <div class="etiqueta-header">‚ö†Ô∏è DANGER</div>
      <div class="etiqueta-body">
        <div class="etq-col etq-pict">‚ö°</div>
        <div class="etq-col">
          <div class="etq-titulo">Peligro de Arco El√©ctrico y de Descarga</div>
          <div class="etq-item"><b>L√≠mite de Protecci√≥n Arco El√©ctrico</b><span id="etq-afb">‚Äî</span></div>
          <div class="etq-item"><b>Energ√≠a Incidente (cal/cm¬≤)</b><span id="etq-ei" class="etq-dato-rojo">‚Äî</span></div>
          <div class="etq-item"><b>Distancia de Trabajo</b><span id="etq-dist">‚Äî</span></div>
          <div class="etq-item"><b>Nivel Requerido de EPP</b><span id="etq-cat" class="etq-cat">‚Äî</span></div>

          <div class="etq-item"><b>Tensi√≥n de Peligro de Choque</b><span id="etq-vac" class="etq-dato-rojo">‚Äî</span></div>
          <div class="etq-item"><b>Acercamiento Limitado</b><span id="etq-lim">‚Äî</span></div>
          <div class="etq-item"><b>Acercamiento Restringido</b><span id="etq-res">‚Äî</span></div>
        </div>
        <div class="etq-col etq-pict">‚ö°</div>
      </div>
      <div class="etq-footer">
        <span id="etq-equipo">Equipo ‚Äî</span>
        <span id="etq-fecha">‚Äî</span>
      </div>
      <div class="etq-acc">
        <button class="btn btn-ok" id="btnValidarEtiqueta">VALIDAR</button>
        <button class="btn btn-secondary" id="btnGuardarEtiqueta">Guardar etiqueta (HTML)</button>
        <button class="btn btn-secondary" id="btnEnviarEtiqueta">Enviar por email</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODALES ===== -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <button class="close-btn" id="modalClose" aria-label="Cerrar">‚úñ</button>
    <h4 id="modalTitle">Ayuda</h4>
    <div id="modalContent"></div>
  </div>
</div>

<!-- ===== OVERLAY: prohibici√≥n cuando CAT 3/4 ===== -->
<div id="blockOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="blockTitle">
  <div class="panel">
    <h3 id="blockTitle">üö´ Trabajo PROHIBIDO ‚Äî Riesgo de Arco El√©ctrico (CAT <span id="blockCat">3‚Äì4</span>)</h3>
    <div class="callout">
      <p><strong>No continuar con la tarea.</strong> Comun√≠quese con <strong>Mantenimiento El√©ctrico</strong> y revise el plan/EPP antes de cualquier acci√≥n.</p>
    </div>
    <ul>
      <li>Detener el trabajo y notificar al supervisor.</li>
      <li>Aplicar LOTO si corresponde.</li>
      <li>Contactar a Mantenimiento El√©ctrico.</li>
    </ul>
    <div class="actions">
      <button class="btn primary" id="contactBtn">Contactar Mantenimiento</button>
      <button class="btn secondary" id="ackBtn">Entendido</button>
    </div>
  </div>
</div>

<script>
  // ===== Modo oscuro =====
  const appCard = document.getElementById('appCard');
  document.getElementById('btnMode').addEventListener('click', () => {
    const current = appCard.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    appCard.setAttribute('data-theme', next);
    document.getElementById('btnMode').textContent = next === 'dark' ? '‚òÄÔ∏è Modo claro' : 'üåô Modo oscuro';
  });

  // ===== LOTO visual =====
  function verificarTarea() {
    document.getElementById('alertaPeligro').style.display =
      (document.getElementById('tipo').value === 'Contacto') ? 'block' : 'none';
  }
  window.verificarTarea = verificarTarea;

  // ===== Z% t√≠pica por kVA =====
  function zPctFromKVA(kva) {
    if (kva >= 10 && kva <= 25)   return 3.5;
    if (kva >= 30 && kva <= 75)   return 4.25;
    if (kva >= 100 && kva <= 150) return 4.75;
    if (kva >= 200 && kva <= 300) return 5.25;
    if (kva >= 400 && kva <= 500) return 5.75;
    if (kva >= 630 && kva <= 750) return 5.85;
    if (kva >= 800 && kva <= 1000) return 6.5;
    return 5.75;
  }

  // ===== Tipos gen√©ricos de protecci√≥n =====
  function dpDefaults(tipo) {
    switch (tipo) {
      case 'MCCB_CHICO':  return { t: 0.010, kA: 25 };
      case 'MCCB_MEDIO':  return { t: 0.015, kA: 36 };
      case 'FUSIBLE_J':   return { t: 0.010, kA: 100 };
      case 'FUSIBLE_RK5': return { t: 0.012, kA: 50 };
      case 'DISY_GRANDE': return { t: 0.025, kA: 50 };
      default:            return { t: null, kA: null };
    }
  }

  // ===== Estimaciones (orden de magnitud) =====
  function estimarEI(ka, t, volt, dist_cm) {
    const C = 46.2;
    return C * ka * t * Math.pow(480/volt, 0.5) * Math.pow(45/dist_cm, 1.5);
  }
  function getPPECategory(ei) {
    if (ei <= 1.2) return "Sin categor√≠a (‚â§ 1.2 cal/cm¬≤)";
    if (ei <= 4)   return "CATEGOR√çA 1 (ATPV ‚â• 4)";
    if (ei <= 8)   return "CATEGOR√çA 2 (ATPV ‚â• 8)";
    if (ei <= 25)  return "CATEGOR√çA 3 (ATPV ‚â• 25)";
    if (ei <= 40)  return "CATEGOR√çA 4 (ATPV ‚â• 40)";
    return "CATEGOR√çA 4 (EI > 40) ‚Äî Evaluaci√≥n adicional";
  }
  // NUEVO: categor√≠a num√©rica para UI (1..4)
  function getPPECategoryNumber(ei) {
    if (ei <= 4)   return 1;  // incluye ‚â§ 1.2
    if (ei <= 8)   return 2;
    if (ei <= 25)  return 3;
    if (ei <= 40)  return 4;
    return 4; // mayor a 40 lo tratamos como CAT 4 (alto riesgo)
  }

  function cortoDesdeTx(kva, vll, zpct) {
    const Ifl = (kva*1000)/(Math.sqrt(3)*vll);
    const Zpu = zpct/100;
    const IscA = Ifl / Zpu;
    return IscA/1000;
  }
  function arcoBoundary(ei_work, dist_cm) {
    if (ei_work <= 0) return "‚Äî";
    const Db_cm = dist_cm * Math.pow(ei_work/1.2, 1/1.5);
    return (Db_cm/100).toFixed(2) + " m";
  }
  function shockBoundaries(volt) {
    if (volt <= 150) return { limited: "N/A (‚â§150 V ‚Äî evitar contacto)", restricted: "N/A" };
    if (volt <= 750) return { limited: "1.07 m", restricted: "0.30 m" };
    if (volt <= 15000) return { limited: "3.05 m", restricted: "0.81 m" };
    return { limited: "Personal calificado ‚Äî consultar NFPA", restricted: "Personal calificado ‚Äî consultar NFPA" };
  }

  // ===== Inputs y chips =====
  const kvaInput = document.getElementById('kva');
  const zpctView = document.getElementById('zpct_view');
  const dpTipoSel = document.getElementById('dp_tipo_gen');
  const dpChip = document.getElementById('dp_chip');
  const dpAvChk = document.getElementById('dp_avanzado');
  const dpAvBox = document.getElementById('dp_avanzado_box');
  const tInput = document.getElementById('tiempo');
  const kAInput = document.getElementById('dp_kA');

  function refreshZpct() {
    const kva = parseFloat(kvaInput.value);
    if (!isFinite(kva)) { zpctView.value = "‚Äî"; return; }
    const z = zPctFromKVA(kva);
    zpctView.value = z.toFixed(2) + " %";
  }
  function refreshDPDefaults() {
    const tipo = dpTipoSel.value;
    const def = dpDefaults(tipo);
    if (tipo === 'OTRO') {
      dpChip.textContent = "t=‚Äî s ‚Ä¢ kA=‚Äî";
      dpAvChk.checked = true;
      dpAvBox.style.display = "grid";
      tInput.value = ""; kAInput.value = "";
    } else {
      dpChip.textContent = `t=${def.t.toFixed(3)} s ‚Ä¢ kA=${def.kA}`;
      if (!dpAvChk.checked) {
        tInput.value = def.t; kAInput.value = def.kA;
        dpAvBox.style.display = "none";
      }
    }
  }
  kvaInput.addEventListener('input', refreshZpct);
  dpTipoSel.addEventListener('change', refreshDPDefaults);
  dpAvChk.addEventListener('change', () => {
    dpAvBox.style.display = dpAvChk.checked ? "grid" : "none";
    if (!dpAvChk.checked) refreshDPDefaults();
  });
  refreshZpct(); refreshDPDefaults();

  // ===== Modal gen√©rico (ayuda / VIT gu√≠a) =====
  const backdrop = document.getElementById('modalBackdrop');
  const modalClose = document.getElementById('modalClose');
  const modalTitle = document.getElementById('modalTitle');
  const modalContent = document.getElementById('modalContent');

  document.getElementById('btnInfoZ').addEventListener('click', () => {
    modalTitle.textContent = "Impedancia t√≠pica (Z%) por potencia (kVA)";
    modalContent.innerHTML = `
      <p>La impedancia (<b>Z%</b>) se usa para estimar el corto disponible. Si no se conoce la placa, se aplican valores t√≠picos por kVA:</p>
      <ul>
        <li>10‚Äì25 kVA ‚Üí ~3.5%</li><li>30‚Äì75 kVA ‚Üí ~4.25%</li><li>100‚Äì150 kVA ‚Üí ~4.75%</li>
        <li>200‚Äì300 kVA ‚Üí ~5.25%</li><li>400‚Äì500 kVA ‚Üí ~5.75%</li><li>630‚Äì750 kVA ‚Üí ~5.85%</li>
        <li>800‚Äì1000 kVA ‚Üí ~6.5%</li>
      </ul>
      <p><b>Nota:</b> Si el valor real de placa difiere, usar ese valor. Este c√°lculo es <i>estimativo</i>.</p>
    `;
    backdrop.style.display = "flex";
  });

  document.getElementById('btnInfoDP').addEventListener('click', () => {
    modalTitle.textContent = "Tipos gen√©ricos de protecci√≥n (t y kA t√≠picos)";
    modalContent.innerHTML = `
      <p>Para estimar el tiempo de despeje (<b>t</b>) y la capacidad interruptiva (<b>kA</b>):</p>
      <ul>
        <li><b>MCCB peque√±o (‚â§250 A):</b> t‚âà0.010 s, kA‚âà25</li>
        <li><b>MCCB mediano (250‚Äì630 A):</b> t‚âà0.015 s, kA‚âà36</li>
        <li><b>Fusible Clase J:</b> t‚âà0.010 s, kA‚âà100</li>
        <li><b>Fusible Clase RK5:</b> t‚âà0.012 s, kA‚âà50</li>
        <li><b>Disyuntor industrial (>630 A):</b> t‚âà0.025 s, kA‚âà50</li>
      </ul>
      <p>Si ten√©s la curva/modelo del equipo, eleg√≠ ‚Äú<b>OTRO</b>‚Äù y edit√° <b>t</b> y <b>kA</b> manualmente.</p>
    `;
    backdrop.style.display = "flex";
  });

  document.getElementById('btnVITGuia').addEventListener('click', () => {
    modalTitle.textContent = "Gu√≠a visual VIT el√©ctrica ‚Äî Trabajos con energ√≠a/alta tensi√≥n";
    const items = [
      { id:'alcance',       titulo:'Alcance autorizado',             desc:'Revisar permiso/plan. Analizar detener si cambian condiciones.' },
      { id:'identificacion',titulo:'Identificaci√≥n del equipo',      desc:'Equipo correcto y etiquetado. N¬∞ de etiqueta / marcas.' },
      { id:'epp',           titulo:'EPP calificado',                 desc:'EPP para tensi√≥n/arco, inspeccionado y sin da√±os.' },
      { id:'barreras',      titulo:'Barreras/acceso restringido',    desc:'Colocar barreras y controlar acceso. Cumplir l√≠mites NFPA.' },
      { id:'guardia',       titulo:'Guardia el√©ctrica',              desc:'Presente (si aplica), responsabilidades y rescate.' },
      { id:'comunicacion',  titulo:'Plan de comunicaci√≥n',           desc:'Se√±ales para detener y activar emergencias.' },
      { id:'herramientas',  titulo:'Herramientas/equipos de prueba', desc:'Certificados, ensayados. Prueba de voltaje previa.' },
      { id:'emergencias',   titulo:'Plan de emergencias',            desc:'Materiales en sitio; equipo de rescate disponible.' }
    ];
    let html = '';
    items.forEach(it=>{
      html += `
      <div class="modal-grid">
        <!-- Si existen im√°genes, coloc√° aqu√≠ <img src="vit/${it.id}.jpg" alt="${it.titulo}"> -->
        <div></div>
        <div>
          <div class="m-title">${it.titulo}</div>
          <div>${it.desc}</div>
        </div>
      </div>`;
    });
    modalContent.innerHTML = html;
    backdrop.style.display = "flex";
  });

  modalClose.addEventListener('click', () => backdrop.style.display = "none");
  backdrop.addEventListener('click', (e) => { if (e.target === backdrop) backdrop.style.display = "none"; });

  // ===== Estado del c√°lculo =====
  let ultimoResultado = null;

  // ===== Validaci√≥n y c√°lculo =====
  document.getElementById('btnCalcular').addEventListener('click', generarValidacion);
  function generarValidacion() {
    const nombre = document.getElementById('nombre').value.trim();
    const equipo  = document.getElementById('equipo').value.trim();
    const volt    = parseFloat(document.getElementById('volt').value);
    const dist    = parseFloat(document.getElementById('dist').value);
    const kva     = parseFloat(document.getElementById('kva').value);

    const zpct    = zPctFromKVA(kva);
    const tipoDP  = document.getElementById('dp_tipo_gen').value;
    const vitOK = ['vit1','vit2','vit3','vit4','vit5','vit6','vit7','vit8'].map(id=>document.getElementById(id).checked).every(x=>x);

    const dpAvChk = document.getElementById('dp_avanzado').checked;
    let t = null, dp_kA = null;
    if (tipoDP === 'OTRO' || dpAvChk) {
      t = parseFloat(document.getElementById('tiempo').value);
      dp_kA = parseFloat(document.getElementById('dp_kA').value);
    } else {
      const def = dpDefaults(tipoDP); t = def.t; dp_kA = def.kA;
    }

    if (!nombre || !equipo || !isFinite(volt) || !isFinite(dist) || !isFinite(kva)) { alert("Completar operador, equipo, tensi√≥n, distancia y kVA."); return; }
    if (!isFinite(t) || !isFinite(dp_kA)) { alert("Completar t y kA del dispositivo (o elegir tipo gen√©rico)."); return; }
    if (!vitOK) { alert("Complete la VIT el√©ctrica (8 verificaciones) antes de validar."); return; }

    const ka_tx = cortoDesdeTx(kva, volt, zpct);
    const ei = estimarEI(ka_tx, t, volt, dist);
    const cat = getPPECategory(ei);
    const catNum = getPPECategoryNumber(ei);     // NUEVO: n√∫mero de categor√≠a
    const shock = shockBoundaries(volt);
    const afb_m = arcoBoundary(ei, dist);

    // Sugerencia de EPP (texto)
    let eppSug = "Algod√≥n no fundible; EPP FR no requerido (ATPV ‚â• 1.2).";
    if (catNum === 1)      eppSug = "ATPV ‚â• 4 cal/cm¬≤ (CAT 1).";
    else if (catNum === 2) eppSug = "ATPV ‚â• 8 cal/cm¬≤ + protecci√≥n facial/balaclava (CAT 2).";
    else if (catNum === 3) eppSug = "ATPV ‚â• 25 cal/cm¬≤ + capucha arco y guantes (CAT 3).";
    else if (catNum === 4) eppSug = "ATPV ‚â• 40 cal/cm¬≤ y medidas adicionales (CAT 4).";

    // Colores por categor√≠a (pedido):
    // CAT ‚â§ 1 -> VERDE | CAT 2 -> AMARILLO | CAT 3/4 -> ROJO + overlay
    let colorFondo, colorTexto;
    if (catNum <= 1)       { colorFondo = "#1f8c3a"; colorTexto = "white"; }
    else if (catNum === 2) { colorFondo = "#f5a623"; colorTexto = "black"; }
    else { // CAT 3 o 4
      colorFondo = "#d0021b"; colorTexto = "white";
      document.getElementById('blockCat').textContent = String(catNum);
      document.getElementById('blockOverlay').style.display = "flex";
    }

    const res = document.getElementById('res-display');
    res.style.display = "block";
    res.style.backgroundColor = colorFondo;
    res.style.borderColor = "#fff";
    res.style.color = colorTexto;

    const fecha = new Date().toLocaleString();
    const tipoTarea = document.getElementById('tipo').value;

    res.innerHTML = `
      <h3 style="margin-top:0; border-bottom:1px solid ${colorTexto};">REPORTE ‚Äî Evaluaci√≥n de Riesgo El√©ctrico</h3>
      <p><strong>Fecha/Hora:</strong> ${fecha}</p>
      <p><strong>Operador:</strong> ${nombre}</p>
      <p><strong>Equipo:</strong> ${equipo}</p>
      <p><strong>Tarea:</strong> ${tipoTarea}</p>

      <h4>Par√°metros</h4>
      <p>V=${volt} V ‚Ä¢ Dist=${dist} cm ‚Ä¢ Tx=${kva} kVA ‚Ä¢ Z=${zpct.toFixed(2)}%</p>
      <p><strong>Dispositivo:</strong> ${tipoDP} ‚Ä¢ t=${t.toFixed(3)} s ‚Ä¢ kA=${dp_kA}</p>
      <p><strong>Corto estimado (sec Tx):</strong> ${ka_tx.toFixed(2)} kA</p>
      <p><strong>Energ√≠a incidente (estimada):</strong> ${ei.toFixed(2)} cal/cm¬≤</p>
      <p><strong>L√≠mite de protecci√≥n arco (AFB):</strong> ${afb_m}</p>
      <p><strong>Fronteras de choque:</strong> Limitado=${shock.limited} ‚Ä¢ Restringido=${shock.restricted}</p>

      <p><strong>Categor√≠a de EPP (orientativa):</strong> ${cat}</p>
      <p><strong>EPP sugerido (por ATPV):</strong> ${eppSug}</p>

      <h4>VIT El√©ctrica ‚Äî OK</h4>
      <ul style="margin-top:6px">
        <li>Alcance autorizado</li>
        <li>Identificaci√≥n del equipo</li>
        <li>EPP calificado</li>
        <li>Barreras y acceso restringido</li>
        <li>Guardia el√©ctrica</li>
        <li>Plan de comunicaci√≥n</li>
        <li>Herramientas y equipos de prueba</li>
        <li>Plan de emergencias</li>
      </ul>

      <p class="disclaimer" style="background: rgba(255,255,255,0.2); border-color: ${colorTexto};">
        Resultado estimativo. Use un m√©todo por equipo (tablas NFPA 70E o an√°lisis IEEE 1584). Ajuste <b>t</b> seg√∫n curvas reales y valide contra el estudio.
      </p>
    `;

    ultimoResultado = { fecha, nombre, equipo, volt, dist, kva, zpct, tipoDP, dp_kA, t, ka_tx, ei, afb_m, shock, cat, eppSug };
    window.scrollTo(0, document.body.scrollHeight);
  }

  // ===== Crear etiqueta =====
  document.getElementById('btnCrearEtiqueta').addEventListener('click', () => {
    if (!ultimoResultado) { alert("Primero valide y calcule (bot√≥n VALIDAR)."); return; }
    const e = ultimoResultado;
    const cont = document.getElementById('etiqueta-container');
    cont.style.display = "block";

    document.getElementById('etq-afb').textContent  = `${e.afb_m}`;
    document.getElementById('etq-ei').textContent   = `${e.ei.toFixed(2)}`;
    document.getElementById('etq-dist').textContent = `${e.dist} cm`;
    document.getElementById('etq-cat').textContent  = `${e.cat}`;
    document.getElementById('etq-vac').textContent  = `${e.volt} VAC`;
    document.getElementById('etq-lim').textContent  = `${e.shock.limited}`;
    document.getElementById('etq-res').textContent  = `${e.shock.restricted}`;
    document.getElementById('etq-equipo').textContent = `Equipo ${e.equipo}`;
    document.getElementById('etq-fecha').textContent  = new Date().toLocaleDateString();

    window.scrollTo(0, document.body.scrollHeight);
  });

  // Validar etiqueta (requiere VIT OK)
  document.getElementById('btnValidarEtiqueta').addEventListener('click', () => {
    const vitOK = ['vit1','vit2','vit3','vit4','vit5','vit6','vit7','vit8'].map(id=>document.getElementById(id).checked).every(x=>x);
    alert(vitOK ? "Etiqueta validada con VIT el√©ctrica OK." : "Complete la VIT el√©ctrica antes de validar la etiqueta.");
  });

  // Guardar etiqueta (HTML)
  document.getElementById('btnGuardarEtiqueta').addEventListener('click', () => {
    const cont = document.getElementById('etiqueta-container');
    if (cont.style.display !== 'block') { alert('Cree la etiqueta primero.'); return; }
    const html = `
      <html><head><meta charset="UTF-8"><title>Etiqueta Arco - El Trapial</title>
      <style>${document.querySelector('style').innerHTML}</style></head><body>
      ${cont.outerHTML}
      </body></html>`;
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `Etiqueta_${(ultimoResultado?.equipo||'equipo').replace(/\s+/g,'_')}.html`;
    a.click(); URL.revokeObjectURL(url);
  });

  // Enviar por email
  document.getElementById('btnEnviarEtiqueta').addEventListener('click', () => {
    if (!ultimoResultado) { alert("Primero crea la etiqueta."); return; }
    const e = ultimoResultado;
    const asunto = `Etiqueta Arco/Choque ‚Äî ${e.equipo} ‚Äî ${new Date().toLocaleDateString()}`;
    const cuerpo = `Equipo: ${e.equipo}%0AFecha: ${e.fecha}%0A`+
      `EI (cal/cm2): ${e.ei.toFixed(2)}%0A`+
      `AFB: ${e.afb_m}%0A`+
      `Distancia trabajo (cm): ${e.dist}%0A`+
      `Categor√≠a EPP: ${e.cat}%0A`+
      `Tensi√≥n choque (VAC): ${e.volt}%0A`+
      `Acercamiento limitado: ${e.shock.limited}%0A`+
      `Acercamiento restringido: ${e.shock.restricted}%0A`+
      `Tx: ${e.kva} kVA / Z=${e.zpct.toFixed(2)}% ‚Äî Icc‚âà ${e.ka_tx.toFixed(2)} kA%0A`+
      `Dispositivo: ${e.tipoDP} ‚Ä¢ t=${e.t.toFixed(3)} s ‚Ä¢ kA=${e.dp_kA}%0A`+
      `EPP sugerido: ${e.eppSug}%0A`+
      `VIT el√©ctrica: OK`;
    const mailto = `mailto:mantenimientotrapialelectrico@chevron.com?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(cuerpo)}`;
    window.location.href = mailto;
  });

  // ===== Reporte general (sin firma) =====
  document.getElementById('btnDescargar').addEventListener('click', descargarReporte);
  function descargarReporte() {
    const res = document.getElementById('res-display');
    if (res.style.display !== 'block') { alert('Primero genere el reporte.'); return; }
    const printable = `
      <html><head><meta charset="UTF-8"><title>Reporte VIT</title>
      <style> body { font-family: Segoe UI, Tahoma, sans-serif; margin: 20px; color:#111; }
              h2 { color:#005daa; }
              .box { border:1px solid #ccc; padding:12px; border-radius:8px; background:#fafafa; }
      </style></head><body>
        <h2>Evaluaci√≥n de Riesgo para Trabajo El√©ctrico ‚Äî El Trapial</h2>
        <div class="box">${res.innerHTML}</div>
      </body></html>`;
    const blob = new Blob([printable], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const w = window.open(url, '_blank'); if (w) w.onload = () => w.print();
  }

  // ===== Guardar/Cargar registro =====
  document.getElementById('btnGuardarRegistro').addEventListener('click', () => {
    const payload = {
      nombre: document.getElementById('nombre').value.trim(),
      equipo: document.getElementById('equipo').value.trim(),
      tipo: document.getElementById('tipo').value,
      volt: document.getElementById('volt').value,
      dist: document.getElementById('dist').value,
      kva: document.getElementById('kva').value,
      zpct: document.getElementById('zpct_view').value,
      dp_tipo_gen: document.getElementById('dp_tipo_gen').value,
      tiempo: document.getElementById('tiempo').value,
      dp_kA: document.getElementById('dp_kA').value,
      resHTML: document.getElementById('res-display').innerHTML,
      ts: new Date().toISOString()
    };
    localStorage.setItem('vit_electrica_last', JSON.stringify(payload));
    alert('Registro guardado localmente.');
  });

  document.getElementById('btnCargarRegistro').addEventListener('click', () => {
    const raw = localStorage.getItem('vit_electrica_last');
    if (!raw) { alert('No hay registros guardados.'); return; }
    const p = JSON.parse(raw);
    document.getElementById('nombre').value = p.nombre || '';
    document.getElementById('equipo').value = p.equipo || '';
    document.getElementById('tipo').value = p.tipo || 'Inspeccion';
    document.getElementById('volt').value = p.volt || '';
    document.getElementById('dist').value = p.dist || '';
    document.getElementById('kva').value = p.kva || '';
    document.getElementById('zpct_view').value = p.zpct || '‚Äî';
    document.getElementById('dp_tipo_gen').value = p.dp_tipo_gen || 'MCCB_CHICO';
    (function refreshDPDefaultsAfterLoad(){
      const def = dpDefaults(document.getElementById('dp_tipo_gen').value);
      document.getElementById('dp_chip').textContent =
        def.t ? `t=${def.t.toFixed(3)} s ‚Ä¢ kA=${def.kA}` : 't=‚Äî s ‚Ä¢ kA=‚Äî';
    })();
    document.getElementById('tiempo').value = p.tiempo || '';
    document.getElementById('dp_kA').value = p.dp_kA || '';

    const res = document.getElementById('res-display');
    if (p.resHTML) { res.innerHTML = p.resHTML; res.style.display = 'block'; }
    alert('√öltimo registro cargado.');
  });

  // ===== Overlay: botones =====
  document.getElementById('ackBtn')?.addEventListener('click', () => {
    document.getElementById('blockOverlay').style.display = 'none';
  });
  document.getElementById('contactBtn')?.addEventListener('click', () => {
    // Reemplazar por mailto corporativo si corresponde
    // window.location.href = 'mailto:mantenimientotrapialelectrico@chevron.com?subject=Alerta%20CAT%20alta';
    alert('Contactar Mantenimiento El√©ctrico');
  });

  // ===== Service Worker para PWA =====
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(err => console.error('SW fail:', err));
  }
</script>
</body>
</html>

















